INSERT OVERWRITE TABLE shipment_adm_l1_fact
SELECT distinct
T2.shipment_id,
T2.vendor_tracking_id,
T2.original_tracking_id,
T2.merchant_reference_id,
T2.merchant_id,
T2.seller_id,
T2.order_id,
T2.order_external_id,
T2.actioned_runsheet_id,
T2.shipment_current_status,
T2.first_undelivery_status,
T2.last_undelivery_status,
T2.refund_status,
T2.return_reason,
T2.return_sub_reason,
T2.refund_reason,
T2.return_action,
T2.return_status,
T2.refund_mode,
T2.return_type,
T2.reject_reason,
T2.reject_sub_reason,
T2.payment_type,
T2.payment_mode,
T2.transaction_id,
T2.amount_collected,
T2.seller_type,
T2.packing_box_type,
T2.item_quantity,
T2.shipment_dg_flag,
T2.shipment_fragile_flag,
T2.shipment_priority_flag,
T2.shipment_size_flag,
T2.ekl_shipment_type,
T2.reverse_shipment_type,
T2.national_hop_breach_score,
T2.number_of_hops,
T2.number_of_air_hops,
T2.line_haul_breach_score,
T2.number_of_ftl_hops,
T2.tc_connection_breach_score,
T2.number_of_offloads,
T2.air_hop_breach_score,
T2.actual_route_map,
T2.shipment_fa_flag,
T2.shipment_pending_flag,
T2.goods_recon_pending_flag,
T2.fsd_number_of_ofd_attempts,
T2.cost_of_breach,
T2.shipment_value,
T2.cod_amount_to_collect,
T2.shipment_charge,
T2.vendor_id_key,
T2.pos_id_key,
T2.seller_id_key,
T2.primary_product_key,
T2.agent_id_key,
T2.source_pincode_key,
T2.destination_pincode_key,
T2.customer_address_id_key,
T2.customer_address_id,
T2.vendor_service_type,
T2.cs_notes,
T2.hub_notes,
T2.shipment_pending_age,
T2.asset_pending_age,
T2.accountable_function_pending_age_in_days,
T2.accountable_function,
T2.shipment_pending_location,
T2.return_bucket,
T2.return_sub_bucket,
T2.customer_dependency_flag,
T2.last_mile_breach_flag,
T2.misroute_flag,
T2.customer_misroute_flag,
T2.shipment_origin_facility_id_key,
T2.shipment_origin_mh_facility_id_key,
T2.shipment_destination_mh_facility_id_key,
T2.shipment_destination_facility_id_key,
T2.shipment_first_received_dh_id_key,
T2.shipment_last_received_dh_id_key,
T2.shipment_first_received_hub_id_key,
T2.shipment_last_received_hub_id_key,
T2.shipment_first_received_mh_id_key,
T2.fsd_assigned_hub_id_key,
T2.reverse_pickup_hub_id_key,
T2.shipment_ideal_dh_key,
T2.shipment_current_hub_id_key,
T2.shipment_current_hub_type,
T2.shipment_first_out_for_pickup_date_key,
T2.shipment_created_at_date_key,
T2.shipment_created_at_time_key,
T2.shipment_first_received_date_key,
T2.shipment_first_received_time_key,
T2.shipment_delivered_at_date_key,
T2.shipment_delivered_at_time_key,
T2.fsd_last_update_time_key,
T2.fsd_last_receive_date_key,
T2.customer_promise_date_key,
T2.customer_promise_time_key,
T2.logistics_promise_date_key,
T2.new_customer_promise_date_key,
T2.new_customer_promise_time_key,
T2.new_logistics_promise_date_key,
T2.new_logistics_promise_time_key,
T2.fsd_first_dh_received_date_key,
T2.fsd_first_dh_received_time_key,
T2.fsd_last_dh_received_date_key,
T2.fsd_last_dh_received_time_key,
T2.fsd_first_ofd_date_key,
T2.fsd_first_ofd_time_key,
T2.fsd_last_ofd_date_key,
T2.fsd_last_ofd_time_key,
T2.shipment_first_rvp_pickup_date_key,
T2.shipment_first_rvp_pickup_time_key,
T2.shipment_last_rvp_pickup_date_key,
T2.shipment_last_rvp_pickup_time_key,
T2.mp_requested_date_key,
T2.mp_requested_time_key,
T2.mp_day,
T2.reqested_hour,
T2.mp_pickup_promise_date_key, 
T2.mp_pickup_promise_time_key,
T2.shipment_current_status_date_key,
T2.shipment_current_status_time_key,
T2.order_item_date_key,
T2.order_item_time_key,
T2.rto_create_date_key,
T2.rto_create_time_key,
T2.rto_complete_date_key,
T2.rto_complete_time_key,
T2.fe_name_key,
lookup_date(T4.received_at_pickup_store) as received_at_pickup_store_date_key,
lookup_time(T4.received_at_pickup_store) as received_at_pickup_store_time_key,
if( array_contains(T1.`data`.vas_ids,('Customer Pickup')) or array_contains(T1.`data`.vas_ids,('customer pickup')) ,"Customer Initiated",(if(T3.flag = 'Y',"Ekart Initiated",Null))) as pickup_flag,
if((T5.min_rank-T6.max_rank) = 1,1,0) as is_delivered_flag,
if((T5.min_rank-T7.max_rank) = 1,1,0) as is_picked_flag,
T3.pickup_center_id,
T2.service_tier,
T2.ekl_fin_zone
FROM 
(select 
shipment_id,
vendor_tracking_id,
original_tracking_id,
merchant_reference_id,
merchant_id,
seller_id,
order_id,
order_external_id,
actioned_runsheet_id,
shipment_current_status,
first_undelivery_status,
last_undelivery_status,
refund_status,
return_reason,
return_sub_reason,
refund_reason,
return_action,
return_status,
refund_mode,
return_type,
reject_reason,
reject_sub_reason,
payment_type,
payment_mode,
transaction_id,
amount_collected,
seller_type,
packing_box_type,
item_quantity,
shipment_dg_flag,
shipment_fragile_flag,
shipment_priority_flag,
shipment_size_flag,
ekl_shipment_type,
reverse_shipment_type,
national_hop_breach_score,
number_of_hops,
number_of_air_hops,
line_haul_breach_score,
number_of_ftl_hops,
tc_connection_breach_score,
number_of_offloads,
air_hop_breach_score,
actual_route_map,
shipment_fa_flag,
shipment_pending_flag,
goods_recon_pending_flag,
fsd_number_of_ofd_attempts,
cost_of_breach,
shipment_value,
cod_amount_to_collect,
shipment_charge,
vendor_id_key,
pos_id_key,
seller_id_key,
primary_product_key,
agent_id_key,
source_pincode_key,
destination_pincode_key,
customer_address_id_key,
customer_address_id,
vendor_service_type,
cs_notes,
hub_notes,
shipment_pending_age,
asset_pending_age,
accountable_function_pending_age_in_days,
accountable_function,
shipment_pending_location,
return_bucket,
return_sub_bucket,
customer_dependency_flag,
last_mile_breach_flag,
misroute_flag,
customer_misroute_flag,
shipment_origin_facility_id_key,
shipment_origin_mh_facility_id_key,
shipment_destination_mh_facility_id_key,
shipment_destination_facility_id_key,
shipment_first_received_dh_id_key,
shipment_last_received_dh_id_key,
shipment_first_received_hub_id_key,
shipment_last_received_hub_id_key,
shipment_first_received_mh_id_key,
fsd_assigned_hub_id_key,
reverse_pickup_hub_id_key,
shipment_ideal_dh_key,
shipment_current_hub_id_key,
shipment_current_hub_type,
shipment_first_out_for_pickup_date_key,
shipment_created_at_date_key,
shipment_created_at_time_key,
shipment_first_received_date_key,
shipment_first_received_time_key,
shipment_delivered_at_date_key,
shipment_delivered_at_time_key,
fsd_last_update_time_key,
fsd_last_receive_date_key,
customer_promise_date_key,
customer_promise_time_key,
logistics_promise_date_key,
new_customer_promise_date_key,
new_customer_promise_time_key,
new_logistics_promise_date_key,
new_logistics_promise_time_key,
fsd_first_dh_received_date_key,
fsd_first_dh_received_time_key,
fsd_last_dh_received_date_key,
fsd_last_dh_received_time_key,
fsd_first_ofd_date_key,
fsd_first_ofd_time_key,
fsd_last_ofd_date_key,
fsd_last_ofd_time_key,
shipment_first_rvp_pickup_date_key,
shipment_first_rvp_pickup_time_key,
shipment_last_rvp_pickup_date_key,
shipment_last_rvp_pickup_time_key,
mp_requested_date_key,
mp_requested_time_key,
mp_day,
reqested_hour,
mp_pickup_promise_date_key, 
mp_pickup_promise_time_key,
shipment_current_status_date_key,
shipment_current_status_time_key,
order_item_date_key,
order_item_time_key,
rto_create_date_key,
rto_create_time_key,
rto_complete_date_key,
rto_complete_time_key,
service_tier,
ekl_fin_zone,
fe_name_key FROM bigfoot_external_neo.scp_ekl__shipment_hive_90_fact where shipment_carrier in ('FSD'))T2 
left outer join bigfoot_snapshot.dart_wsr_scp_ekl_b2clogisticsrequest_1_1_view T1
on T2.merchant_reference_id=T1.`data`.merchant_reference_id
left outer join 
(select distinct
`data`.vendor_tracking_id as vendor_tracking_id,
'Y' as flag ,
`data`.current_address.id as pickup_center_id
from bigfoot_journal.dart_wsr_scp_ekl_shipment_4
where  day > #100#DAY# and lower(`data`.current_address.type)='pickup_center') T3
on T2.vendor_tracking_id=T3.vendor_tracking_id 
left outer join 
(select 
`data`.vendor_tracking_id as vendor_tracking_id,
 cast(min(updatedat) as timestamp) as received_at_pickup_store
from bigfoot_journal.dart_wsr_scp_ekl_shipment_4
where  day > #100#DAY# and lower(`data`.status) in ('received') and lower(`data`.current_address.type)='pickup_center'
group by `data`.vendor_tracking_id ) T4
on T2.vendor_tracking_id=T4.vendor_tracking_id
left outer join
(select vendor_tracking_id,status,min_rank from bigfoot_external_neo.scp_ekl__shipment_adm_intermediate_fact where lower(status) IN ('delivered'))T5
on T2.vendor_tracking_id=T5.vendor_tracking_id
left outer join
(select vendor_tracking_id,status,max_rank from bigfoot_external_neo.scp_ekl__shipment_adm_intermediate_fact where lower(status) IN ('out_for_delivery'))T6
on T2.vendor_tracking_id=T6.vendor_tracking_id
left outer join 
(select vendor_tracking_id,status,max_rank from bigfoot_external_neo.scp_ekl__shipment_adm_intermediate_fact where lower(status) IN ('ready_for_pickup'))T7
on T2.vendor_tracking_id=T7.vendor_tracking_id;